---
title: "Bias examples"
output: html_document
date: "2024-10-04"
---

```{r}
git_directory <- system("git rev-parse --show-toplevel", intern = TRUE)
data_folder <- file.path(git_directory, "Data", "National_Data")
code_folder <- file.path(git_directory, "Code", "Analysis")
nhcs_hfrs_all <- readRDS(file.path(data_folder, "hfrs_rescaled.RData"))
nhcs_hfr_dates <- as.Date(names(nhcs_hfrs_all))
source(file.path(code_folder, "helper_functions.R"))

library(ggplot2)
library(patchwork)
```

# Example 1: One-hot delay distribution elucidates bias due to changing severity rate

```{r}

lag <- 21
ratio_hfr_dates <- nhcs_hfr_dates + lag
ratio_hfrs <- nhcs_hfrs_all; names(ratio_hfrs) <-  ratio_hfr_dates

plot(nhcs_hfr_dates, nhcs_hfrs_all, type="l", xlab="Date", ylab="HFR", main="True vs Est HFR, one-hot delay")
lines(ratio_hfr_dates, ratio_hfrs, type="l", col="red")
```

# Example 1/2: one-hot delay, short and long delay

```{r}
short_lag <- 14
long_lag <- 28
estDates <- nhcs_hfr_dates[(long_lag+1):length(nhcs_hfr_dates)]
est_hfrs_short <- nhcs_hfrs_all[nhcs_hfr_dates %in% (estDates-short_lag)]
est_hfrs_long <- nhcs_hfrs_all[nhcs_hfr_dates %in% (estDates-long_lag)]
gt_nhcs <- nhcs_hfrs_all[nhcs_hfr_dates %in% estDates]
HFRtypes <- c("GT", "Est, Short Delay", "Est, Long Delay")
df <- data.frame(Date=rep(estDates, 3),
                  HFR=c(gt_nhcs,est_hfrs_short,est_hfrs_long),
                  Method=factor(rep(HFRtypes, each=length(estDates)), levels=HFRtypes))

pConst <- ggplot(df, aes(x=Date, y=HFR, color=Method, linetype=Method)) + 
  geom_line() + 
  ggtitle("All deaths at same delay. True & Estimated HFRs.") +#Constant Primary Incidence. 
  theme(legend.position="bottom",
        legend.title = element_blank())
plot(pConst)

```

# Example 2: Constant primary incidence elucidates bias due to delay distribution shape.

```{r}
Ns <- c(28611, 1700, 16641, 16903)
means <- c(10.20, 14.06, 14.84, 9.24)
sds <- c(9.51, 14.31, 12.35, 7.64)
gamma_mean <- sum(means*Ns/sum(Ns)) # Weighted average hosp-to-death time
gamma_sd <- sum(sds*Ns/sum(Ns)) # Weighted average of SDs

# delay_shape <- readRDS(file.path(data_folder, "delay_shape.RData"))
d <- 75
params <- get_gamma_params(Mean=gamma_mean, Sd=gamma_sd) # Produces Mean & Var ~ 1.5 below desired value
shape <- params[1]; rate <- params[2]
# shape <- 2.75; rate <- 1/5
# delay_shape <- readRDS(file.path(data_folder, "delay_shape.RData"))

delay_distr_short <- ddgamma(0:d, shape, rate)
plot(0:d, delay_distr_short)

# Delay distribution for report date
gamma_mean_report <- 28
gamma_sd_report <- 21
params <- get_gamma_params(Mean=gamma_mean_report, Sd=gamma_sd_report) 
shape <- params[1]; rate <- params[2]
delay_distr_long <- ddgamma(0:d, shape, rate)
plot(0:d, delay_distr_long)
```

```{r}
death_dates <- nhcs_hfr_dates[(d+1):length(nhcs_hfr_dates)]
est_hfrs_short <- sapply(death_dates, function(t) {
  trailing_dates <- seq(t-d, t, by="day")
  trailing_hfrs <- nhcs_hfrs_all[nhcs_hfr_dates %in% trailing_dates]
  est_hfrs <- sum(trailing_hfrs * rev(delay_distr_short))
}); names(est_hfrs_short) <- death_dates

est_hfrs_long <- sapply(death_dates, function(t) {
  trailing_dates <- seq(t-d, t, by="day")
  trailing_hfrs <- nhcs_hfrs_all[nhcs_hfr_dates %in% trailing_dates]
  est_hfrs <- sum(trailing_hfrs * rev(delay_distr_long))
}); names(est_hfrs_long) <- death_dates

plot(nhcs_hfr_dates, nhcs_hfrs_all, type="l", xlab="Date", ylab="HFR", main="True vs Est HFR, const primary, short & long delay distr")
lines(death_dates, est_hfrs_short, type="l", col="red")
lines(death_dates, est_hfrs_long, type="l", col="blue")

```

```{r}
# short_bias <- est_hfrs_short - gt_nhcs
# trans_factor <- max(gt_nhcs) * 0.75 / max(short_bias)
# 
# plot(nhcs_hfr_dates, nhcs_hfrs_all, type="l", xlab="Date", ylab="HFR", main="True vs Est HFR, const primary, short & long delay distr",
#      ylim=c(min(short_bias*trans_factor), max(gt_nhcs)))
# lines(death_dates, short_bias*trans_factor, type="l", col="red")
# lines(death_dates, est_hfrs_long*trans_factor, type="l", col="blue")

```


# Example 3: Two-day delay distribution elucidates bias due to primary incidence
# 3a, Linear trend. Predictable relation on convolutional ratio; lagged usually same but fails at inflection points

```{r}
n_dates <- 300
sim_hfrs <- seq(0.5, 0, length.out=n_dates)

days <- c(0, 10)
two_day_d <- max(days)
two_day_delay <- rep(0, two_day_d+1); two_day_delay[days+1] <- 0.5
est_indices <- (two_day_d+1):n_dates

len_sec <- n_dates/5
hosps <- c(rep(1000, len_sec), seq(1000, 10000, length.out=len_sec), rep(10000, len_sec), 
           seq(10000, 1000, length.out=len_sec), rep(1000, len_sec))
plot(hosps)

exp_deaths <- sapply(est_indices, function(t) {
  trailing_idx <- (t-two_day_d):t
  trailing_hfrs <- sim_hfrs[trailing_idx]
  hosps_in_trailing_window <- hosps[trailing_idx]
  exp_deaths_t <- sum(hosps_in_trailing_window * trailing_hfrs * rev(two_day_delay))
})

conv_hfrs <- sapply(est_indices, function(t) {
  trailing_idx <- (t-two_day_d):t
  hosps_in_trailing_window <- hosps[trailing_idx]
  deaths_t <- exp_deaths[t-two_day_d]
  hfr_t <- deaths_t/sum(hosps_in_trailing_window * rev(two_day_delay))
})
lag <- mean(days)
lagged_hfrs <- sapply(est_indices, function(t) {
  hfr_t <- exp_deaths[t-two_day_d]/hosps[t-lag]
})
n_est <- length(est_indices)
gt_hfrs <- sim_hfrs[est_indices]
plot(1:n_est, gt_hfrs, type="l", xlab="Date", ylab="HFR", main="True vs Est HFR", ylim=c(0, max(conv_hfrs, lagged_hfrs, gt_hfrs)))
lines(1:n_est, conv_hfrs, type="l", col="red")
lines(1:n_est, lagged_hfrs, type="l", col="blue")
lines(1:n_est, hosps[est_indices]/max(hosps)*max(sim_hfrs)*.75, type="l", col="green")

plot(1:n_est, gt_hfrs, type="l", xlab="Date", ylab="HFR", main="True HFR & bias")
conv_bias <- conv_hfrs-gt_hfrs
lines(1:n_est, conv_bias/max(conv_bias)*max(sim_hfrs)*.75, type="l", col="red")
lagged_bias <- lagged_hfrs-gt_hfrs
lines(1:n_est, lagged_bias/max(conv_bias)*max(sim_hfrs)*.75, type="l", col="blue")
lines(1:n_est, hosps[est_indices]/max(hosps)*max(sim_hfrs)*.75, type="l", col="green")

which.max(lagged_hfrs) + two_day_d
lagged_hfrs[which.max(lagged_hfrs)-0]
```



# Example 3b: Smooth curve. Reveals lagged has fundamentally different bias! Not simple inverse relation btwn primary incidence & bias.


```{r}
n_dates <- 300
sim_hfrs <- seq(0.5, 0, length.out=n_dates)

days <- c(0, 20)
two_day_d <- max(days)
two_day_delay <- rep(0, two_day_d+1); two_day_delay[days+1] <- 0.5
est_indices <- (two_day_d+1):n_dates

len_sec <- n_dates/5
hosps <- dcauchy(seq(-5, 5, length.out=n_dates))/dnorm(0)*10000

exp_deaths <- sapply(est_indices, function(t) {
  trailing_idx <- (t-two_day_d):t
  trailing_hfrs <- sim_hfrs[trailing_idx]
  hosps_in_trailing_window <- hosps[trailing_idx]
  exp_deaths_t <- sum(hosps_in_trailing_window * trailing_hfrs * rev(two_day_delay))
})

conv_hfrs <- sapply(est_indices, function(t) {
  trailing_idx <- (t-two_day_d):t
  hosps_in_trailing_window <- hosps[trailing_idx]
  deaths_t <- exp_deaths[t-two_day_d]
  hfr_t <- deaths_t/sum(hosps_in_trailing_window * rev(two_day_delay))
})
lag <- mean(days)
# lag <- min(days)
lagged_hfrs <- sapply(est_indices, function(t) {
  hfr_t <- exp_deaths[t-two_day_d]/hosps[t-lag]
})
n_est <- length(est_indices)
gt_hfrs <- sim_hfrs[est_indices]
plot(1:n_est, gt_hfrs, type="l", xlab="Date", ylab="HFR", main="True vs Est HFR", 
     ylim=c(min(conv_hfrs, lagged_hfrs, gt_hfrs), max(conv_hfrs, lagged_hfrs, gt_hfrs)))
lines(1:n_est, conv_hfrs, type="l", col="red")
lines(1:n_est, lagged_hfrs, type="l", col="blue")
lines(1:n_est, hosps[est_indices]/max(hosps)*max(sim_hfrs)*.75, type="l", col="green")

############
conv_bias <- conv_hfrs-gt_hfrs
conv_bias_rescaled <- conv_bias/max(conv_bias)*max(sim_hfrs)*.75

lagged_bias <- lagged_hfrs-gt_hfrs
lagged_bias_rescaled <- lagged_bias/max(conv_bias)*max(sim_hfrs)*.75

hosps_rescaled <- hosps[est_indices]/max(hosps)*max(sim_hfrs)*.75

plot(1:n_est, gt_hfrs, type="l", xlab="Date", ylab="HFR", main="True HFR, biases, and changing primary",
     ylim=c(min(conv_bias_rescaled, lagged_bias_rescaled, gt_hfrs), max(conv_bias_rescaled, lagged_bias_rescaled, gt_hfrs)))
lines(1:n_est, lagged_bias_rescaled, type="l", col="blue")
lines(1:n_est, hosps_rescaled, type="l", col="green")
lines(1:n_est, conv_bias_rescaled, type="l", col="red")

# which.max(lagged_hfrs) + two_day_d
# lagged_hfrs[which.max(lagged_hfrs)-0]
```

As ggplot


```{r}


# Calculate the scale transformation factor for the secondary axis
trans_factor <- max(sim_hfrs) * 0.75 / max(conv_bias)

# data$Line <- factor(rep(c("True HFR", "Hospitalizations", "Lagged Bias", "Conv Bias"), each=n_est), 
#                     levels=c("True HFR", "Hospitalizations", "Lagged Bias", "Conv Bias"))
data <- data.frame(
  Date = rep(1:n_est, 4),
  Value = c(gt_hfrs, hosps_rescaled, lagged_bias*trans_factor, conv_bias*trans_factor),
  Line = factor(rep(c("True HFR", "Hospitalizations", "Lagged Bias", "Conv Bias"), each=n_est), 
                    levels=c("True HFR", "Hospitalizations", "Lagged Bias", "Conv Bias"))
)
pChg <- ggplot(data, aes(x = Date, y = Value, colour = Line)) +
  geom_line() +
  labs(x = "Date", y = "HFR Level", title = "Changing Primary Incidence. True HFR and Estimation Bias.",
       colour = "Legend") +
  scale_colour_manual(values = c("True HFR" = "black", "Hospitalizations" = "green", 
                                 "Lagged Bias" = "blue", "Conv Bias" = "red")) +
  theme(legend.title=element_blank(), legend.position="bottom") +
  ylim(range(c(min(conv_bias_rescaled, lagged_bias_rescaled, gt_hfrs), 
               max(conv_bias_rescaled, lagged_bias_rescaled, gt_hfrs)))) +
  scale_y_continuous(sec.axis = sec_axis(~ . / trans_factor, name = "Bias Level"))
plot(pChg)

```

```{r}
n_dates <- 300
sim_hfrs <- seq(0.5, 0, length.out=n_dates)

sigmoid <- function(x) {
  return (1/(1+exp(-x)))
}
xs <- seq(-9, 7, length.out=n_dates/2)
hosps <- (c(sigmoid(xs), rev(sigmoid(xs)))*9000 + 1000)
plot(hosps)
# hosps <- dcauchy(seq(-5, 5, length.out=n_dates))/dnorm(0)*10000


days <- c(0, 10)
two_day_d <- max(days)
two_day_delay <- rep(0, two_day_d+1); two_day_delay[days+1] <- 0.5
est_indices <- (two_day_d+1):n_dates

exp_deaths <- sapply(est_indices, function(t) {
  trailing_idx <- (t-two_day_d):t
  trailing_hfrs <- sim_hfrs[trailing_idx]
  hosps_in_trailing_window <- hosps[trailing_idx]
  exp_deaths_t <- sum(hosps_in_trailing_window * trailing_hfrs * rev(two_day_delay))
})

conv_hfrs <- sapply(est_indices, function(t) {
  trailing_idx <- (t-two_day_d):t
  hosps_in_trailing_window <- hosps[trailing_idx]
  deaths_t <- exp_deaths[t-two_day_d]
  hfr_t <- deaths_t/sum(hosps_in_trailing_window * rev(two_day_delay))
})
lag <- mean(days)
# lag <- min(days)
lagged_hfrs <- sapply(est_indices, function(t) {
  hfr_t <- exp_deaths[t-two_day_d]/hosps[t-lag]
})
n_est <- length(est_indices)
gt_hfrs <- sim_hfrs[est_indices]

plot(1:n_est, gt_hfrs, type="l", xlab="Date", ylab="HFR", main="True vs Est HFR", 
     ylim=c(min(conv_hfrs, lagged_hfrs, gt_hfrs), max(conv_hfrs, lagged_hfrs, gt_hfrs)))
lines(1:n_est, conv_hfrs, type="l", col="red")
lines(1:n_est, lagged_hfrs, type="l", col="blue")
lines(1:n_est, hosps[est_indices]/max(hosps)*max(sim_hfrs)*.75, type="l", col="green")


hosps_rescaled <- hosps[est_indices]/max(hosps)*max(sim_hfrs, lagged_hfrs, conv_hfrs)*1.5 #0.75
conv_bias <- conv_hfrs-gt_hfrs
conv_bias_rescaled <- conv_bias/max(conv_bias)*max(sim_hfrs)*.75
lagged_bias <- lagged_hfrs-gt_hfrs
trans_factor <- max(sim_hfrs) * 0.75 / max(conv_bias)
lagged_bias_rescaled <- lagged_bias/max(conv_bias)*max(sim_hfrs)*.75

data <- data.frame(
  Date = rep(1:n_est, 4),
  Value = c(gt_hfrs, hosps_rescaled, lagged_bias*trans_factor, conv_bias*trans_factor),
  Line = factor(rep(c("True HFR", "Hospitalizations", "Lagged Bias", "Conv Bias"), each=n_est), 
                    levels=c("True HFR", "Hospitalizations", "Lagged Bias", "Conv Bias"))
)
pChg <- ggplot(data, aes(x = Date, y = Value, colour = Line)) +
  geom_line() +
  labs(x = "Date", y = "HFR Level", title = "Changing Primary Incidence. True HFR and Estimation Bias.",
       colour = "Legend") +
  scale_colour_manual(values = c("True HFR" = "black", "Hospitalizations" = "green", 
                                 "Lagged Bias" = "blue", "Conv Bias" = "red")) +
  theme(legend.title=element_blank(), legend.position="bottom") +
  ylim(range(c(min(conv_bias_rescaled, lagged_bias_rescaled, gt_hfrs), 
               max(conv_bias_rescaled, lagged_bias_rescaled, gt_hfrs)))) +
  scale_y_continuous(sec.axis = sec_axis(~ . / trans_factor, name = "Bias Level"))
plot(pChg)
```

