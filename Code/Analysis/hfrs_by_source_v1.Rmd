
```{r}
library(tidyverse)
code_path <- "/Users/jeremygoldwasser/Desktop/HFR/repo/HFR/Code/Surprises"
source(file.path(code_path, "helper_functions.R"))
library(epidatr)

# Load data
data_folder <- "/Users/jeremygoldwasser/Desktop/HFR/repo/HFR/Data/State_Level_NHCS_HFR"
delay_shape <- readRDS(file.path(data_folder, "delay_shape.RData"))
nhcs_hfrs_all <- readRDS(file.path(data_folder, "smoothed_hfrs.RData"))
nhcs_hfr_dates <- as.Date(names(nhcs_hfrs_all)) # From NCHS/NHCS lol

```




## Deaths
- National Center for Health Statistics (NCHS)
- JHU pretty jagged without pre-smoothing
https://covid.nchs.gov/covid-data-tracker/

```{r}
nchs_df <- read.csv(file.path(data_folder, "../National_Data/us_deaths.csv"), skip=2, header=T)
nchs_df <- nchs_df[nrow(nchs_df):1,]
weekly_dates_nchs <- as.Date(nchs_df$Date, format = "%b %d %Y")
nchs_deaths <- nchs_df$Weekly.Deaths/7; names(nchs_deaths) <- weekly_dates_nchs

daily_dates_nchs <- seq(min(weekly_dates_nchs), max(weekly_dates_nchs), by = "day")
jhu_df <- data.frame(pub_covidcast(source="jhu-csse", signals="deaths_7dav_incidence_num",#
                                    geo_type = "nation", geo_values="*", 
                                    time_type="day", time_values=daily_dates_nchs))

date <- weekly_dates_nchs[100]

jhu_deaths <- sapply(weekly_dates_nchs, function(date) {
  mean(jhu_df$value[jhu_df$time_value %in% seq(date - 6, date, by="day")], na.rm = TRUE)
})
names(jhu_deaths) <- weekly_dates_nchs

plot(weekly_dates_nchs,jhu_deaths, type="l", main="Weekly Deaths", ylab="Deaths", xlab="Dates",)
lines(weekly_dates_nchs,nchs_deaths, col="red")
legend("topright", legend=c("JHU", "NCHS"),
       col=c("black", "red"), lty=1)

# JHU ends early: 3/11/23
last_death_date <- max(weekly_dates_nchs[!is.na(jhu_deaths)])
first_death_date <- min(weekly_dates_nchs[!is.na(jhu_deaths)])
goodIdx <- (weekly_dates_nchs >= first_death_date) & (weekly_dates_nchs <= last_death_date)
jhu_deaths <- jhu_deaths[goodIdx]
weekly_datesD <- weekly_dates_nchs[goodIdx]
# nchs_deaths <- nchs_deaths[goodIdx]
```

## Hospitalizations
- NHSN: Can't find source anymore! Reported weekly.
- Pretty similar to HHS (daily), but couple periods with consistent difference

```{r}
# Goes until 4/20/24
nhsn_df <- read.csv(file.path(data_folder, "../National_Data/us_hosps.csv"), skip=2, header=T)
nhsn_df <- nhsn_df[nrow(nhsn_df):1,]

weekly_dates <- as.Date(nhsn_df$Date, format = "%b %d %Y")
nhsn_hosps <- as.numeric(nhsn_df$Currently.Hospitalized.COVID.19.Patients)/7
# Restart at first non-NA week
first_hosp_date <- min(weekly_dates[!is.na(nhsn_hosps)])
weekly_datesH <- weekly_dates[weekly_dates>=first_hosp_date]
nhsn_hosps <- nhsn_hosps[weekly_dates>=first_hosp_date]; names(nhsn_hosps) <- weekly_datesH

daily_dates_nhsn <- seq(min(weekly_datesH), max(weekly_datesH), by = "day")
hhs_df <- data.frame(pub_covidcast(source="hhs",signals= "confirmed_admissions_covid_1d", 
                                     geo_type = "nation", geo_values="*", 
                                     time_type="day", time_values=daily_dates_nhsn))

hhs_hosps <- sapply(weekly_datesH, function(date) {
  mean(hhs_df$value[hhs_df$time_value %in% seq(date - 6, date, by="day")], na.rm = TRUE)
})
names(hhs_hosps) <- weekly_datesH

plot(weekly_datesH,hhs_hosps, type="l", main="Weekly Hosps", ylab="Deaths", xlab="Dates",)
lines(weekly_datesH,nhsn_hosps, col="red")
legend("topright", legend=c("HHS", "NHSN"),
       col=c("black", "red"), lty=1)

```

### Overlay hospitalizations and deaths by different sources

```{r}
weeks <- intersect_dates(weekly_datesD, weekly_datesH)
last_week <- max(weeks[weeks <= max(nhcs_hfr_dates)])
est_weeks <- seq(min(weeks), last_week-4*7, by="week") #weeks[1:(length(weeks)-4)]

dfH <- data.frame(Date=est_weeks,
                 Hosps=hhs_hosps[as.Date(names(hhs_hosps)) %in% est_weeks],
                 Source="Hosps:HHS")

dfD <- data.frame(Date=rep(est_weeks, 2),
                 Deaths=c(nchs_deaths[weekly_dates_nchs %in% est_weeks], 
                          jhu_deaths[weekly_datesD %in% est_weeks]),
                 Source=rep(c("Deaths:NCHS", "Deaths:JHU"), each=length(est_weeks)))

trans <- mean(dfH$Hosps) / mean(dfD$Deaths)

# Plot for dfH
p <- ggplot(dfH, aes(x = Date, y = Hosps, color = Source, linetype = Source)) + 
  geom_line() +
  ggtitle("US Hospitalizations and Deaths")
  scale_y_continuous(name = "Hospitalizations")

# Overlay the plot for dfD with a different scale
p <- p + geom_line(data = dfD, aes(x = Date, y = Deaths * trans, color = Source, linetype = Source)) +
  scale_y_continuous(sec.axis = sec_axis(~./trans, name = "Deaths")) +
  scale_color_manual(values = c("Hosps:HHS" = "blue", "Deaths:NCHS" = "red", "Deaths:JHU" = "brown")) +
  scale_linetype_manual(values = c("Hosps:HHS" = "solid", "Deaths:NCHS" = "dashed", "Deaths:JHU" = "longdash")) +
  guides(color = guide_legend(title = "Data Source"), linetype = guide_legend(title = "Data Source"))

# Display the plot
print(p)

```
## Compare to variant-level HFRs
```{r}
nat_data_path <- "/Users/jeremygoldwasser/Desktop/HFR/repo/HFR/Data/National_Data"
variant_list <- readRDS( file.path(nat_data_path, 'variant_hfrs.RData'))
variant_hfrs <- variant_list[['HFRs-2wk lag']]
variant_dates <- variant_list[['Variant Dates']]

n_weeks <- length(est_weeks)
const_variant_hfrs <- rep(variant_hfrs[1], n_weeks)
for (i in 1:n_weeks) {
  week <- est_weeks[i]
  if (week >= variant_dates[2] & week < variant_dates[3]) {
    const_variant_hfrs[i] <- variant_hfrs[2] }
  if (week >= variant_dates[3] & week < variant_dates[4]) {
    const_variant_hfrs[i] <- variant_hfrs[3] }
  # if (week >= variant_dates[4]) {
  #   const_variant_hfrs[i] <- variant_hfrs[4] }
  if (week >= variant_dates[4] & week < variant_dates[5]) {
    const_variant_hfrs[i] <- variant_hfrs[5] }
  if (week >= variant_dates[5]) {
    const_variant_hfrs[i] <- variant_hfrs[6] }
}
names(const_variant_hfrs) <- est_weeks

# Changing HFRs by proportion in circulation
prop_df <- variant_list[['Proportions']]
variant_names <- c("Original", "Alpha", "Delta", "Omicron")
prop_variant_hfrs_all <- as.matrix(prop_df[,variant_names]) %*% variant_hfrs[variant_names]
names(prop_variant_hfrs_all) <- prop_df$Date

prop_variant_hfrs <- approx(as.numeric(prop_df$Date), prop_variant_hfrs_all, as.numeric(est_weeks))$y
names(prop_variant_hfrs) <- est_weeks

late_omicron_start <- variant_dates["Late Omicron"]
hfr_start <- as.matrix(prop_df[prop_df$Date < late_omicron_start,variant_names]) %*%
  variant_hfrs[c("Original", "Alpha", "Delta", "Early Omicron")]
hfr_end <- as.matrix(prop_df[prop_df$Date >= late_omicron_start,variant_names]) %*%
  variant_hfrs[c("Original", "Alpha", "Delta", "Late Omicron")]
prop_variant_hfrs_all <- c(hfr_start, hfr_end)
prop_variant_hfrs <- approx(as.numeric(prop_df$Date), prop_variant_hfrs_all, as.numeric(est_weeks))$y
names(prop_variant_hfrs) <- est_weeks
```


```{r}

hfrsNHCS <- sapply(est_weeks, function(date) {
  mean(nhcs_hfrs_all[nhcs_hfr_dates %in% seq(date - 6, date, by="day")], na.rm = TRUE)
}); names(hfrsNHCS) <- est_weeks

lag <- 14
hfrsHN <- compute_lagged_hfrs(hhs_hosps, nchs_deaths,
                              l=lag, w=0, dates=est_weeks, weekly=TRUE, 
                              forward=FALSE, centered=FALSE)
hfrsHJ <- compute_lagged_hfrs(hhs_hosps, jhu_deaths,
                                   l=lag, w=0, dates=est_weeks, weekly=TRUE, 
                              forward=FALSE, centered=FALSE)
HFRtypes <- c("NHCS Survey", "NCHS/HHS", "JHU/HHS", "GT-Variants")#"GT-Const", GT-Proportional

Dtypes <- c("NCHS", "JHU")
dfHFR <- data.frame(Date=rep(est_weeks, length(HFRtypes)),
                 HFR=c(hfrsNHCS, hfrsHN, hfrsHJ, prop_variant_hfrs),#, 
                 Method=rep(HFRtypes, each=length(hfrsNHCS)))

# labels <- c("Alpha", "Delta", "Omicron")
labels <- c("Alpha", "Delta", "Omicron", "Late Omicron")
date_vec <- variant_dates[labels]
ggplot(data=dfHFR, aes(x = Date, y = HFR, color = Method, linetype = Method)) + 
  geom_line() + labs(color = "HFR", linetype = "HFR") + 
  geom_vline(xintercept = as.numeric(date_vec), color = "black") +
  ggtitle("US HFRs, 2-week lag")

```




#### Plot HFRs with different lags
- Also plot deaths to show how it can get messed up

```{r}
lags <- c(1,2,3)*7
hfrs_by_lag <- lapply(lags, function(lag) {
  compute_lagged_hfrs(hhs_hosps, nchs_deaths, l=lag, w=0, dates=est_weeks, weekly=TRUE)
})
dfHFR <- data.frame(Date=rep(est_weeks, length(lags)),
                 HFR=unlist(hfrs_by_lag),
                 Lag=factor(rep(lags, each=length(est_weeks))))

dfD <- data.frame(Date=est_weeks,
                 Deaths=nchs_deaths[weekly_dates_nchs %in% est_weeks])

ggplot(dfHFR, aes(x = Date, y = HFR, color = Lag, linetype = Lag)) +
  geom_line() + ggtitle("HFRs by lag", subtitle="NCHS deaths")

```
## Repeat with JHU

```{r}

hfrs_by_lag <- lapply(lags, function(lag) {
  compute_lagged_hfrs(hhs_hosps, jhu_deaths, l=lag, w=0, dates=est_weeks, weekly=TRUE)
})
dfHFR <- data.frame(Date=rep(est_weeks, length(lags)),
                 HFR=unlist(hfrs_by_lag),
                 Lag=factor(rep(lags, each=length(est_weeks))))

dfD <- data.frame(Date=est_weeks,
                 Deaths=jhu_deaths[weekly_dates_nchs %in% est_weeks])

ggplot(dfHFR, aes(x = Date, y = HFR, color = Lag, linetype = Lag)) +
  geom_line() + ggtitle("HFRs by lag", subtitle="JHU deaths")
```



###### Plot hosps & deaths at different lags


```{r, fig.width=8, fig.height=7}

library(ggplot2)
library(gridExtra)

plots <- list()

for (lag in lags) {
  death_weeks <- est_weeks+lag
  dfAgg <- data.frame(Date=est_weeks, Hosps = hhs_hosps[weekly_datesH %in% est_weeks], 
                      Deaths_NCHS=nchs_deaths[as.Date(names(nchs_deaths)) %in% death_weeks],
                      Deaths_JHU=jhu_deaths[as.Date(names(jhu_deaths)) %in% death_weeks])
  head(dfAgg)
  dfAgg$Legend_JHU <- "Deaths, JHU"
  dfAgg$Legend_NCHS <- "Deaths, NCHS"
  dfAgg$Legend_HHS <- "Hospitalizations, HHS"
  p <- ggplot(dfAgg, aes(x = Date, y = Hosps)) +
    geom_line(aes(color=Legend_HHS, linetype=Legend_HHS)) + 
    ggtitle(paste0(lag, "-day Lag"))
  trans <- mean(hhs_hosps) / mean(jhu_deaths)
  position <- ifelse(lag==21, "bottom", "none")
  p <- p + 
    geom_line(data = dfAgg, aes(x = Date, y = Deaths_NCHS * trans, color = Legend_NCHS, linetype = Legend_NCHS)) + 
    geom_line(data = dfAgg, aes(x = Date, y = Deaths_JHU * trans, color = Legend_JHU, linetype = Legend_JHU)) + 
    scale_y_continuous(name = "Hospitalizations", sec.axis = sec_axis(~./trans, name = "Deaths")) + 
    scale_linetype_manual(values = c("Hospitalizations, HHS" = "solid", "Deaths, NCHS" = "dashed", "Deaths, JHU" = "longdash")) +
    theme(legend.position=position,
          legend.title=element_blank())
  plots[[length(plots) + 1]] <- p
  
}

# Arrange plots and legend
grid.arrange(grobs = plots, nrow = 3)

```



##### Now repeat on different states, see if it's the same


```{r, fig.width=7, fig.height=5}
nchs_df <- read.csv(file.path(data_folder, "../State_Data/state_deaths.csv"))
nchs_df <- nchs_df[nchs_df$Group=="By Week",]

# Select state
BiggestStates <- c("California", "Texas", "Florida", "New York", "Pennsylvania")
BiggestSTs <- c("CA","TX","FL","NY","PA")
for (i in 1:5) {
  State <- BiggestStates[i]; ST <- BiggestSTs[i]; st <- tolower(ST)
  df_state <- nchs_df[nchs_df$State==State,]
  weekly_dates_nchs <- as.Date(df_state$End.Date, format = "%m/%d/%Y")
  nchs_deaths <- df_state$COVID.19.Deaths/7; names(nchs_deaths) <- weekly_dates_nchs
  
  daily_dates_nchs <- seq(min(weekly_dates_nchs), max(weekly_dates_nchs), by = "day")
  jhu_df <- data.frame(pub_covidcast(source="jhu-csse", signals="deaths_7dav_incidence_num",#
                                      geo_type = "state", geo_values=st, 
                                      time_type="day", time_values=daily_dates_nchs))
  jhu_deaths <- sapply(weekly_dates_nchs, function(date) {
    mean(jhu_df$value[jhu_df$time_value %in% seq(date - 6, date, by="day")], na.rm = TRUE)
  })
  names(jhu_deaths) <- weekly_dates_nchs
  
  plot(weekly_dates_nchs,jhu_deaths, type="l", main=paste("Weekly Deaths,", State), 
       ylab="Deaths", xlab="Dates",ylim=c(0,max(jhu_deaths,nchs_deaths,na.rm=T)))
  lines(weekly_dates_nchs,nchs_deaths, col="red")
  legend("topright", legend=c("JHU", "NCHS"),
         col=c("black", "red"), lty=1)
  
  # Subset JHU deaths
  last_death_date <- max(weekly_dates_nchs[!is.na(jhu_deaths)])
  first_death_date <- min(weekly_dates_nchs[!is.na(jhu_deaths)])
  goodIdx <- (weekly_dates_nchs >= first_death_date) & (weekly_dates_nchs <= last_death_date)
  jhu_deaths <- jhu_deaths[goodIdx]
  weekly_datesD <- weekly_dates_nchs[goodIdx]
  
  # Pull state hospitalizations
  hhs_df <- data.frame(pub_covidcast(source="hhs",signals= "confirmed_admissions_covid_1d", 
                                       geo_type = "state", geo_values=st, 
                                       time_type="day", time_values=daily_dates_nhsn))
  hhs_hosps <- sapply(weekly_datesH, function(date) {
    mean(hhs_df$value[hhs_df$time_value %in% seq(date - 6, date, by="day")], na.rm = TRUE)
  }); names(hhs_hosps) <- weekly_datesH
  
  weeks <- intersect_dates(weekly_datesD, weekly_datesH)
  last_week <- max(weeks[weeks <= max(nhcs_hfr_dates)])
  est_weeks <- seq(min(weeks), last_week-4*7, by="week")
  
  
  hfrsNHCS <- sapply(est_weeks, function(date) {
    mean(nhcs_hfrs_all[nhcs_hfr_dates %in% seq(date - 6, date, by="day")], na.rm = TRUE)
  }); names(hfrsNHCS) <- est_weeks
  
  lag <- 14
  hfrsHN <- compute_lagged_hfrs(hhs_hosps, nchs_deaths,
                                     l=lag, w=0, dates=est_weeks, weekly=TRUE)
  hfrsHJ <- compute_lagged_hfrs(hhs_hosps, jhu_deaths,
                                     l=lag, w=0, dates=est_weeks, weekly=TRUE)
  # HFRtypes <- c("US HFR:NHCS", paste(ST, "HFR:NCHS"), paste(ST, "HFR:JHU"))
  HFRtypes <- c("US:NHCS", paste(ST, "NCHS/HHS"), paste(ST, "JHU/HHS"))
  Dtypes <- c("NCHS", "JHU")
  dfHFR <- data.frame(Date=rep(est_weeks, 3),
                   HFR=c(hfrsNHCS, hfrsHN, hfrsHJ),
                   Method=rep(HFRtypes, each=length(hfrsNHCS)))
  
  plot(ggplot(dfHFR, aes(x = Date, y = HFR, color = Method, linetype = Method)) + 
    geom_line() + 
    labs(color = "HFR", linetype = "HFR") + ggtitle(paste("HFRs,", State)))
}

```

Repeat on small state
- JHU always reported deaths; NCHS did not

```{r}
SmallestStates <- c("Alaska", "North Dakota", "South Dakota", "Delaware", "Montana")
SmallestSTs <- c("AK","ND","SD","DE","MT")
for (i in 1:5) {
  State <- SmallestStates[i]; ST <- SmallestSTs[i]; st <- tolower(ST)
  df_state <- nchs_df[nchs_df$State==State,]
  weekly_dates_nchs <- as.Date(df_state$End.Date, format = "%m/%d/%Y")
  nchs_deaths <- df_state$COVID.19.Deaths/7; names(nchs_deaths) <- weekly_dates_nchs
  
  daily_dates_nchs <- seq(min(weekly_dates_nchs), max(weekly_dates_nchs), by = "day")
  jhu_df <- data.frame(pub_covidcast(source="jhu-csse", signals="deaths_7dav_incidence_num",#
                                      geo_type = "state", geo_values=st, 
                                      time_type="day", time_values=daily_dates_nchs))
  jhu_deaths <- sapply(weekly_dates_nchs, function(date) {
    mean(jhu_df$value[jhu_df$time_value %in% seq(date - 6, date, by="day")], na.rm = TRUE)
  })
  names(jhu_deaths) <- weekly_dates_nchs
  
  plot(weekly_dates_nchs,jhu_deaths, type="l", main=paste("Weekly Deaths,", State), 
       ylab="Deaths", xlab="Dates",ylim=c(0,max(jhu_deaths,nchs_deaths,na.rm=T)))
  lines(weekly_dates_nchs,nchs_deaths, col="red")
  legend("topright", legend=c("JHU", "NCHS"),
         col=c("black", "red"), lty=1)
  
  # Subset JHU deaths
  last_death_date <- max(weekly_dates_nchs[!is.na(jhu_deaths)])
  first_death_date <- min(weekly_dates_nchs[!is.na(jhu_deaths)])
  goodIdx <- (weekly_dates_nchs >= first_death_date) & (weekly_dates_nchs <= last_death_date)
  jhu_deaths <- jhu_deaths[goodIdx]
  weekly_datesD <- weekly_dates_nchs[goodIdx]
  
  # Pull state hospitalizations
  hhs_df <- data.frame(pub_covidcast(source="hhs",signals= "confirmed_admissions_covid_1d", 
                                       geo_type = "state", geo_values=st, 
                                       time_type="day", time_values=daily_dates_nhsn))
  hhs_hosps <- sapply(weekly_datesH, function(date) {
    mean(hhs_df$value[hhs_df$time_value %in% seq(date - 6, date, by="day")], na.rm = TRUE)
  }); names(hhs_hosps) <- weekly_datesH
  
  weeks <- intersect_dates(weekly_datesD, weekly_datesH)
  last_week <- max(weeks[weeks <= max(nhcs_hfr_dates)])
  est_weeks <- seq(min(weeks), last_week-4*7, by="week")
  
  
  hfrsNHCS <- sapply(est_weeks, function(date) {
    mean(nhcs_hfrs_all[nhcs_hfr_dates %in% seq(date - 6, date, by="day")], na.rm = TRUE)
  }); names(hfrsNHCS) <- est_weeks
  
  lag <- 14
  hfrsHN <- compute_lagged_hfrs(hhs_hosps, nchs_deaths,
                                     l=lag, w=0, dates=est_weeks, weekly=TRUE)
  hfrsHJ <- compute_lagged_hfrs(hhs_hosps, jhu_deaths,
                                     l=lag, w=0, dates=est_weeks, weekly=TRUE)
  # HFRtypes <- c("US HFR:NHCS", paste(ST, "HFR:NCHS"), paste(ST, "HFR:JHU"))
  HFRtypes <- c("US:NHCS", paste(ST, "NCHS/HHS"), paste(ST, "JHU/HHS"))
  Dtypes <- c("NCHS", "JHU")
  dfHFR <- data.frame(Date=rep(est_weeks, 3),
                   HFR=c(hfrsNHCS, hfrsHN, hfrsHJ),
                   Method=rep(HFRtypes, each=length(hfrsNHCS)))
  
  plot(ggplot(dfHFR, aes(x = Date, y = HFR, color = Method, linetype = Method)) + 
    geom_line() + 
    labs(color = "HFR", linetype = "HFR") + ggtitle(paste("HFRs,", State)))
}
```

Plot at different window sizes

```{r}
State <- "Alaska"; ST <- "AK"
hhs_df <- data.frame(pub_covidcast(source="hhs",signals= "confirmed_admissions_covid_1d", 
                                     geo_type = "state", geo_values=tolower(ST), 
                                     time_type="day", time_values=nhcs_hfr_dates))
hhs_hosps <- sapply(weekly_datesH, function(date) {
  mean(hhs_df$value[hhs_df$time_value %in% seq(date - 6, date, by="day")], na.rm = TRUE)
}); names(hhs_hosps) <- weekly_datesH

jhu_df <- data.frame(pub_covidcast(source="jhu-csse", signals="deaths_7dav_incidence_num",#
                                      geo_type = "state", geo_values=tolower(ST), 
                                      time_type="day", time_values=nhcs_hfr_dates))
jhu_deaths <- sapply(weekly_dates_nchs, function(date) {
  mean(jhu_df$value[jhu_df$time_value %in% seq(date - 6, date, by="day")], na.rm = TRUE)
})
names(jhu_deaths) <- weekly_dates_nchs

ws <- (0:2)*14+1
hfrs_by_w <- lapply(ws, function(w) {
  compute_lagged_hfrs(hhs_hosps, jhu_deaths, l=lag, w=w, dates=est_weeks, weekly=TRUE)
})
dfHFR <- data.frame(Date=rep(est_weeks, length(ws)),
                 HFR=unlist(hfrs_by_w),
                 W=factor(rep(ws-1, each=length(est_weeks))))

dfD <- data.frame(Date=est_weeks,
                 Deaths=jhu_deaths[weekly_dates_nchs %in% est_weeks])

ggplot(dfHFR, aes(x = Date, y = HFR, color = W, linetype = W)) +
  geom_line() + ggtitle("HFRs by lag", subtitle="JHU deaths")
```

