library(tidyverse)
```{r}
git_directory <- system("git rev-parse --show-toplevel", intern = TRUE)
data_folder <- file.path(git_directory, "Data", "National_Data")
code_folder <- file.path(git_directory, "Code", "Analysis")
source(file.path(code_folder, "helper_functions.R"))
library(epidatr)
library(extraDistr)
library(stats)



```


## Deaths
- National Center for Health Statistics (NCHS) and JHU, both pulled from Delphi
- Need to pre-smooth JHU



```{r}
# Load NCHS deaths (weekly)
nchs_df <- data.frame(pub_covidcast(source="nchs-mortality",signals= "deaths_covid_incidence_num", 
                                   geo_type = "nation", geo_values="*", 
                                   time_type="week"))
# Shift, to use end-of-week
nchs_df$time_value <- nchs_df$time_value + 6
weekly_dates_nchs <- as.Date(nchs_df$time_value, format = "%b %d %Y")

# Load JHU deaths (daily, smoothed)
# Versioned data with as_of or issues = e.g. 20210602
jhu_df <- data.frame(pub_covidcast(source="jhu-csse", signals="deaths_7dav_incidence_num",
                                    geo_type = "nation", geo_values="*", 
                                    time_type="day")) 
# # Smooth raw counts. For some reason doesn't work as well as using deaths_7dav_incidence_num.
# library(zoo)
# jhu_df$value <- rollapplyr(jhu_df$value, width = 7, FUN = mean, partial=TRUE, align="center")

# Take overlapping dates
max_jhu_date <- as.Date("2023-03-01")
weekly_death_dates <- weekly_dates_nchs[weekly_dates_nchs>=(min(jhu_df$time_value)+6) &
                                    weekly_dates_nchs <= min(max(jhu_df$time_value), max_jhu_date)]
first_date <- min(weekly_death_dates); last_date <- max(weekly_death_dates)
daily_dates <- seq(first_date, last_date, by="day")

# Convert NCHS to daily to compute Nishiura HFRs
nchs_deaths <- nchs_df$value[nchs_df$time_value %in% weekly_death_dates]; names(nchs_deaths) <- weekly_death_dates
nchs_deaths_daily <- spline(weekly_death_dates, nchs_deaths, n=length(daily_dates))$y / 7
names(nchs_deaths_daily) <- daily_dates

# Load and process JHU deaths
jhu_deaths_daily <- jhu_df$value[jhu_df$time_value >= first_date & jhu_df$time_value <= last_date]
names(jhu_deaths_daily) <- daily_dates

# Convert to weekly totals
jhu_deaths <- sapply(weekly_death_dates, function(date) {
  sum(jhu_deaths_daily[daily_dates %in% seq(date - 6, date, by="day")], na.rm = TRUE)
}); names(jhu_deaths) <- weekly_death_dates

# Visualize
plot(weekly_death_dates, nchs_deaths, type="l", main="Weekly Deaths", 
     xlab="Dates", ylab="Total weekly deaths")
lines(weekly_death_dates, jhu_deaths, col="red",)
legend("topright", legend=c("JHU", "NCHS"),
       col=c("black", "red"), lty=1)


```

## Hospitalizations


```{r}
hhs_df <- data.frame(pub_covidcast(source="hhs",signals= "confirmed_admissions_covid_1d", 
                                   geo_type = "nation", geo_values="*", 
                                   time_type="day"))
first_hosp_date <- as.Date("2020-07-14") # Basically all 0 before this
hhs_hosps_daily <- hhs_df$value; names(hhs_hosps_daily) <- hhs_df$time_value
last_hosp_date <- max(hhs_df$time_value)
# Saturdays with hospitalizations
weekly_hosp_dates <- weekly_death_dates[weekly_death_dates >= (first_hosp_date+6) & weekly_death_dates <= last_hosp_date]
hhs_hosps <- sapply(weekly_hosp_dates, function(day) {
  day <- as.Date(day)
  week <- hhs_df[hhs_df$time_value %in% seq(day-6, day, "day"), ]
  sum(week$value)
}); names(hhs_hosps) <- weekly_hosp_dates
plot(weekly_hosp_dates, hhs_hosps, type="l", xlab="Date", xaxt="n", ylab="Total Weekly Hosps", main="Weekly Hospitalizations")
# Define the sequence for dates every three months
date_ticks <- seq(from = min(weekly_hosp_dates), to = max(weekly_hosp_dates), by = "3 months")

# Add the x-axis with custom ticks
axis(1, at = date_ticks, labels = format(date_ticks, "%Y-%m"))

```

```{r}
which.max(hhs_hosps[names(hhs_hosps) >= as.Date("2021-04-01") & names(hhs_hosps) < as.Date("2022-01-01")])
max(hhs_hosps)/7; names(which.max(hhs_hosps))
min(hhs_hosps)/7; names(which.min(hhs_hosps))
```


## Load and compute variant-based HFRs

```{r}
nat_data_path <- "/Users/jeremygoldwasser/Desktop/HFR/repo/HFR/Data/National_Data"
variant_list <- readRDS( file.path(nat_data_path, 'variant_hfrs.RData'))
variant_hfrs <- variant_list[['HFRs-2wk lag']]
variant_dates <- variant_list[['Variant Dates']]

# last_week <- max(weeks[weeks <= max(nhcs_hfr_dates)])
# est_weeks <- seq(min(weeks), last_week-4*7, by="week") #weeks[1:(length(weeks)-4)]
est_weeks <- weekly_hosp_dates[12:(length(weekly_hosp_dates)-14)]

n_weeks <- length(est_weeks)
const_variant_hfrs <- rep(variant_hfrs[1], n_weeks)
for (i in 1:n_weeks) {
  week <- est_weeks[i]
  if (week >= variant_dates[2] & week < variant_dates[3]) {
    const_variant_hfrs[i] <- variant_hfrs[2] }
  if (week >= variant_dates[3] & week < variant_dates[4]) {
    const_variant_hfrs[i] <- variant_hfrs[3] }
  # if (week >= variant_dates[4]) {
  #   const_variant_hfrs[i] <- variant_hfrs[4] }
  if (week >= variant_dates[4] & week < variant_dates[5]) {
    const_variant_hfrs[i] <- variant_hfrs[5] }
  if (week >= variant_dates[5]) {
    const_variant_hfrs[i] <- variant_hfrs[6] }
}
names(const_variant_hfrs) <- est_weeks

# Changing HFRs by proportion in circulation
prop_df <- variant_list[['Proportions']]
variant_names <- c("Original", "Alpha", "Delta", "Omicron")
prop_variant_hfrs_all <- as.matrix(prop_df[,variant_names]) %*% variant_hfrs[variant_names]
names(prop_variant_hfrs_all) <- prop_df$Date

prop_variant_hfrs <- approx(as.numeric(prop_df$Date), prop_variant_hfrs_all, as.numeric(est_weeks))$y
names(prop_variant_hfrs) <- est_weeks

late_omicron_start <- variant_dates["Late Omicron"]
hfr_start <- as.matrix(prop_df[prop_df$Date < late_omicron_start,variant_names]) %*%
  variant_hfrs[c("Original", "Alpha", "Delta", "Early Omicron")]
hfr_end <- as.matrix(prop_df[prop_df$Date >= late_omicron_start,variant_names]) %*%
  variant_hfrs[c("Original", "Alpha", "Delta", "Late Omicron")]
prop_variant_hfrs_all <- c(hfr_start, hfr_end)
prop_variant_hfrs <- approx(as.numeric(prop_df$Date), prop_variant_hfrs_all, as.numeric(est_weeks))$y
names(prop_variant_hfrs) <- est_weeks
```






## Compute HFR estimates

Get delay distribution for Nishiura method
```{r}
Ns <- c(28611, 1700, 16641, 16903)
means <- c(10.20, 14.06, 14.84, 9.24)
sds <- c(9.51, 14.31, 12.35, 7.64)
gamma_mean <- sum(means*Ns/sum(Ns)) # Weighted average hosp-to-death time
gamma_sd <- sum(sds*Ns/sum(Ns)) # Weighted average of SDs

# delay_shape <- readRDS(file.path(data_folder, "delay_shape.RData"))
d <- 75
params <- get_gamma_params(Mean=gamma_mean, Sd=gamma_sd) # Produces Mean & Var ~ 1.5 below desired value
shape <- params[1]; rate <- params[2]
# shape <- 2.75; rate <- 1/5
# delay_shape <- readRDS(file.path(data_folder, "delay_shape.RData"))

delay_shape <- ddgamma(0:d, shape, rate)
delay_mean <- sum(0:d*delay_shape)
print(c(gamma_mean, delay_mean))
print(c(gamma_sd, sqrt(sum(delay_shape*(0:d-delay_mean)**2))))
plot(0:d, delay_shape)

# Delay distribution for report date
# gamma_mean_report <- round(gamma_mean) + 9
# gamma_sd_report <- round(gamma_sd) + 6
gamma_mean_report <- 28
gamma_sd_report <- 21
params <- get_gamma_params(Mean=gamma_mean_report, Sd=gamma_sd_report) 
shape <- params[1]; rate <- params[2]
delay_shape2 <- ddgamma(0:d, shape, rate)
plot(0:d, delay_shape2)

```



```{r}
lag <- round(delay_mean)
hfrsHNl <- compute_lagged_hfrs(hhs_hosps, nchs_deaths,
                              l=lag, w=7, dates=est_weeks, weekly=TRUE)
hfrsHJl <- compute_lagged_hfrs(hhs_hosps, jhu_deaths,
                               l=lag+8, w=7, dates=est_weeks, weekly=TRUE)
hfrsHNn <- compute_ahfrs_dynamic(hhs_hosps_daily, nchs_deaths_daily, est_weeks, delay_shape, w=7)
hfrsHJn <- compute_ahfrs_dynamic(hhs_hosps_daily, jhu_deaths_daily, est_weeks, delay_shape2, w=7)

hfrsHNlretro <- compute_lagged_hfrs(hhs_hosps, nchs_deaths,
                              l=lag, w=7, dates=est_weeks, weekly=TRUE)

```

### Load NHCS HFRs
```{r}
# nhcs_hfrs_all <- readRDS(file.path(data_folder, "smoothed_hfrs.RData"))
# nhcs_hfr_dates <- as.Date(names(nhcs_hfrs_all))
nhcs_hfrs_all <- readRDS(file.path(data_folder, "hfrs_rescaled_v2.RData"))
nhcs_hfr_dates <- as.Date(names(nhcs_hfrs_all))

# Make weekly
hfrsNHCS <- sapply(est_weeks, function(date) {
  mean(nhcs_hfrs_all[nhcs_hfr_dates %in% seq(date - 6, date, by="day")], na.rm = TRUE)
}); names(hfrsNHCS) <- est_weeks

jhu_deaths_est <- jhu_deaths[names(jhu_deaths) %in% est_weeks] 
hhs_hosps_est <- hhs_hosps[names(hhs_hosps) %in% est_weeks]
scale <- mean(jhu_deaths_est)/mean(hhs_hosps_est)/mean(hfrsNHCS, na.rm=T)
scale
hfrsNHCS <- hfrsNHCS*scale
```


## Compare estimated HFRs against versions of ground truth
Either way, estimated HFR (real-time JHU/HHS) is too low during deaths surge in delta, and too high after surge in omicron

Best version: NHCS survey, scaled by proportion in circulation

```{r}
HFRtypes <- c("Approx. GT", "Conv. Estimate", "Lagged Estimate")
dfHFR <- data.frame(Date=rep(est_weeks, length(HFRtypes)),
                 HFR=c(hfrsNHCS, hfrsHJn, hfrsHJl), 
                 Method=factor(rep(HFRtypes, each=length(hfrsNHCS)), levels=HFRtypes))
ggplot(data=dfHFR, aes(x = Date, y = HFR, color = Method, linetype=Method)) + 
  geom_line() + labs(color = "HFR", linetype = "HFR") + 
  ggtitle("US HFRs, JHU vs Approximate Ground Truth") +
  scale_x_date(breaks = seq(as.Date("2020-10-01"), max(dfHFR$Date), by = "3 months"), date_labels = "%b %Y") +
  xlab("") +
  # ylim(c(0.07,0.27)) +
  theme(legend.position="bottom",
        legend.title=element_blank())

```


Compare against all versions.

```{r}
HFRtypes <- c("JHU/HHS (real-time)", "NHCS Survey", "NCHS/HHS (retro)", "GT-Variants")
dfHFR <- data.frame(Date=rep(est_weeks, length(HFRtypes)),
                 HFR=c(hfrsHJn, hfrsNHCS, hfrsHNlretro, prop_variant_hfrs), 
                 Method=factor(rep(HFRtypes, each=length(hfrsNHCS)), levels=HFRtypes))

# labels <- c("Alpha", "Delta", "Omicron")
labels <- c("Alpha", "Delta", "Omicron", "Late Omicron")
date_vec <- variant_dates[labels]
ggplot(data=dfHFR, aes(x = Date, y = HFR, color = Method, linetype = Method)) + 
  geom_line() + labs(color = "HFR", linetype = "HFR") + 
  # geom_vline(xintercept = as.numeric(date_vec), color = "black") +
  ggtitle("US HFRs, JHU vs approximate ground truth") +
  theme(legend.position="bottom")

```

Only compare ground truth

```{r}
HFRtypes <- c("NHCS Survey", "NCHS/HHS (retro)", "GT-Variants")
dfHFR <- data.frame(Date=rep(est_weeks, length(HFRtypes)),
                 HFR=c(hfrsNHCS, hfrsHNlretro, prop_variant_hfrs), 
                 Method=factor(rep(HFRtypes, each=length(hfrsNHCS)), levels=HFRtypes))

labels <- c("Alpha", "Delta", "Omicron", "Late Omicron")
date_vec <- variant_dates[labels]
ggplot(data=dfHFR, aes(x = Date, y = HFR, color = Method, linetype = Method)) + 
  geom_line() + labs(color = "Source", linetype = "Source") + 
  # geom_vline(xintercept = as.numeric(date_vec), color = "black") +
  ggtitle("US HFRs, Methods for Approximate Ground Truth") +
  theme(legend.position = "bottom", legend.title = element_blank())
```

## Compare JHU and NCHS lagged ratios

```{r}
HFRtypes <- c("Approx. GT", "JHU Estimate", "NCHS Estimate")
dfHFR <- data.frame(Date=rep(est_weeks, length(HFRtypes)),
                 HFR=c(hfrsNHCS, hfrsHJl, hfrsHNl), 
                 Method=factor(rep(HFRtypes, each=length(hfrsNHCS)), levels=HFRtypes))
ggplot(data=dfHFR, aes(x = Date, y = HFR, color = Method, linetype=Method)) + 
  geom_line() + labs(color = "HFR", linetype = "HFR") + 
  ggtitle("US HFRs, JHU vs NCHS Deaths") +
  scale_x_date(breaks = seq(as.Date("2020-10-01"), max(dfHFR$Date), by = "3 months"), date_labels = "%b %Y") +
  xlab("") +
  # ylim(c(0.07,0.27)) +
  theme(legend.position="bottom",
        legend.title=element_blank())
```



## Robustness to whether estimator targets time-varying HFR (less important)

```{r}
# hfrsHJnog <- compute_ahfrs_og(hhs_hosps_daily, jhu_deaths_daily, est_weeks, delay_shape, first_hosp_date)
# hfrsHNnog <- compute_ahfrs_og(hhs_hosps_daily, nchs_deaths_daily, est_weeks, delay_shape, first_hosp_date)
# # plot(est_weeks, hfrsHJl, type="l"); lines(est_weeks, hfrsHJnog, col="red")
# # plot(est_weeks, hfrsHNl, type="l"); lines(est_weeks, hfrsHNnog, col="red")
# 
# 
# HFRtypes <- c("NCHS/HHS, dynamic", "NCHS/HHS, constant", "JHU/HHS, constant", "JHU/HHS, dynamic", "GT-Variants")
# dfHFR <- data.frame(Date=rep(est_weeks, length(HFRtypes)),
#                  HFR=c(hfrsHNn, hfrsHNnog, hfrsHJn, hfrsHJnog, prop_variant_hfrs),#, 
#                  Method=rep(HFRtypes, each=length(est_weeks)))
# 
# # labels <- c("Alpha", "Delta", "Omicron")
# labels <- c("Alpha", "Delta", "Omicron", "Late Omicron")
# date_vec <- variant_dates[labels]
# ggplot(data=dfHFR, aes(x = Date, y = HFR, color = Method, linetype = Method)) + 
#   geom_line() + labs(color = "HFR", linetype = "HFR") + 
#   # geom_vline(xintercept = as.numeric(date_vec), color = "black") +
#   ggtitle("HFR analysis only applies for time-varying estimators", 
#           subtitle="Nishiura convolutional estimator for constant HFR")


```


# Robustness checks
### Robustness to choice of estimator: Lagged vs Convolutional produce similar results
- Did this in the main plot

```{r}
# #"NCHS/HHS, lagged", "NCHS/HHS, conv", 
# HFRtypes <- c("JHU/HHS, lagged", "JHU/HHS, conv.", "GT-Variants")
# dfHFR <- data.frame(Date=rep(est_weeks, length(HFRtypes)),
#                  HFR=c( hfrsHJl, hfrsHJn, prop_variant_hfrs),#, 
#                  Method=rep(HFRtypes, each=length(est_weeks)))
# 
# # labels <- c("Alpha", "Delta", "Omicron")
# labels <- c("Alpha", "Delta", "Omicron", "Late Omicron")
# date_vec <- variant_dates[labels]
# ggplot(data=dfHFR, aes(x = Date, y = HFR, color = Method, linetype = Method)) + 
#   geom_line() + labs(color = "HFR", linetype = "HFR") + 
#   geom_vline(xintercept = as.numeric(date_vec), color = "black") +
#   ggtitle("US HFRs, 2-week lag")

```


## Robustness to choice of hyperparameter

### Window size: JHU still messed up

Nishiura convolutional estimator

```{r}
ws <- c(1, 1:4*7)
hfrs_by_w <- lapply(ws, function(w) {
  compute_ahfrs_dynamic(hhs_hosps_daily, jhu_deaths_daily, est_weeks, delay_shape2, w=w)
})
lag_labels <- factor(c(rep("Approx. GT", length(est_weeks)), rep(ws, each=length(est_weeks))),
                     levels=c("Approx. GT", ws))
dfHFR <- data.frame(Date=rep(est_weeks, length(ws)+1),
                 HFR=c(hfrsNHCS, unlist(hfrs_by_w)),
                 Window=lag_labels)

ggplot(dfHFR, aes(x = Date, y = HFR, color = Window, linetype = Window)) +
  geom_line() + 
  ggtitle("HFRs by window size", subtitle="JHU deaths, convolutional HFR")
```
Tune to "ground truth." Best lag is ~3 months. And they're all very similar.
```{r}
# ws <- 1:10*14
# hfrs_by_w2 <- lapply(ws, function(w) {
#   compute_ahfrs_dynamic(hhs_hosps_daily, jhu_deaths_daily, est_weeks, delay_shape, w=w)
# })
# plot(ws,sapply(hfrs_by_w2, mae, vec2=prop_variant_hfrs))
```


Lagged HFR

```{r}
# ws <- 1:5*7
hfrs_by_w_lag <- lapply(ws, function(w) {
  compute_lagged_hfrs(hhs_hosps, jhu_deaths, l=21, w=w, dates=est_weeks, weekly=TRUE)
})
lag_labels <- factor(c(rep("Approx. GT", length(est_weeks)), rep(ws, each=length(est_weeks))),
                     levels=c("Approx. GT", ws))
dfHFR2 <- data.frame(Date=rep(est_weeks, length(ws)+1),
                 HFR=c(hfrsNHCS, unlist(hfrs_by_w_lag)),
                 Window=lag_labels)
ggplot(dfHFR2, aes(x = Date, y = HFR, color = Window, linetype = Window)) +
  geom_line() + 
  ggtitle("HFRs by window size", subtitle="JHU deaths, lagged HFR")


```

```{r, fig.width=8, fig.height=4}
library(patchwork)
p1 <- ggplot(dfHFR, aes(x = Date, y = HFR, color = Window, linetype = Window)) +
  geom_line() + theme(legend.position="none") +
  ggtitle("Lagged Ratio")
p2 <- ggplot(dfHFR2, aes(x = Date, y = HFR, color = Window, linetype = Window)) +
  geom_line() + 
  ggtitle("Convolutional Ratio") +
  xlab("") + ylab("")

windowPlot <- p1+p2 + plot_annotation(
  title = 'HFRs by Trailing Window Length',
  # subtitle = 'JHU Deaths',
)
windowPlot
```

### Lag: JHU is still messed up

```{r}
lags <- 2:5*7
hfrs_by_lag <- lapply(lags, function(lag) {
  compute_lagged_hfrs(hhs_hosps, jhu_deaths, l=lag, w=7, dates=est_weeks, weekly=TRUE)
})
lag_labels <- factor(c(rep("Approx. GT", length(est_weeks)), rep(lags, each=length(est_weeks))),
                     levels=c("Approx. GT", lags))
dfHFR <- data.frame(Date=rep(est_weeks, length(lags)+1),
                 HFR=c(hfrsNHCS, unlist(hfrs_by_lag)),
                 Lag=lag_labels)

ggplot(dfHFR, aes(x = Date, y = HFR, color = Lag, linetype = Lag)) +
  geom_line() + 
  ggtitle("HFRs by Lag Parameter")#, subtitle="JHU deaths, lagged HFR"

```
Show NCHS by lag, why not.

```{r}
lags <- 1:3*7
hfrs_by_lag2 <- lapply(lags, function(lag) {
  compute_lagged_hfrs(hhs_hosps, nchs_deaths, l=lag, w=0, dates=est_weeks, weekly=TRUE)
})
lag_labels <- factor(c(rep("GT-Variants", length(est_weeks)), rep(lags, each=length(est_weeks))),
                     levels=c("GT-Variants", lags))
dfHFR <- data.frame(Date=rep(est_weeks, length(lags)+1),
                 HFR=c(prop_variant_hfrs, unlist(hfrs_by_lag2)),
                 Lag=lag_labels)

ggplot(dfHFR, aes(x = Date, y = HFR, color = Lag, linetype = Lag)) +
  geom_line() + 
  ggtitle("HFRs by lag", subtitle="NCHS deaths, lagged HFR")

```

## Robustness to choice of delay distribution

```{r}
# param_list <- list(round(c(gamma_mean, gamma_sd)),c(15, 12), c(20, 15), c(25, 15), c(30, 20))
# # param_list <- list(c(5, 2), c(40, 10))
# delay_shapes <- lapply(param_list, function(mean_and_sd) {
#   params <- get_gamma_params(Mean=mean_and_sd[1], Sd=mean_and_sd[2])
#   shape <- params[1]; rate <- params[2]
#   ddgamma(0:d, shape, rate)})
delay_shapes <- list(delay_shape, delay_shape2)
hfrs_by_delay <- lapply(delay_shapes, function(delay_shape) {
  compute_ahfrs_dynamic(hhs_hosps_daily, jhu_deaths_daily, est_weeks, delay_shape, w=7)
})

# HFRtypes <- c(param_list, "GT-Variants")
HFRtypes <- c("Delay for Death Date", "Delay for Report Date", "GT-Variants")
dfHFR <- data.frame(Date=rep(est_weeks, length(HFRtypes)),
                 HFR=c(unlist(hfrs_by_delay), prop_variant_hfrs), 
                 Method=factor(rep(HFRtypes, each=length(est_weeks)), levels=HFRtypes))

labels <- c("Alpha", "Delta", "Omicron", "Late Omicron")
date_vec <- variant_dates[labels]
ggplot(data=dfHFR, aes(x = Date, y = HFR, color = Method, linetype = Method)) + 
  geom_line() + labs(color = "HFR", linetype = "HFR") + 
  geom_vline(xintercept = as.numeric(date_vec), color = "black") +
  # labs(color="HFR (delay mean, sd)", linetype="HFR (delay mean, sd)") +
  labs(color="HFR") +
  ggtitle("HFRs by delay distribution", subtitle="JHU deaths, convolutional HFR")
```


###### Plot hosps & deaths at different lags



### Overlay hospitalizations and deaths by different sources

```{r, fig.width=8, fig.height=3}

dfH <- data.frame(Date=est_weeks,
                 Hosps=hhs_hosps[weekly_hosp_dates %in% est_weeks],
                 Source="Hosps:HHS")

dfD <- data.frame(Date=rep(est_weeks, 2),
                 Deaths=c(#nchs_deaths[weekly_death_dates %in% est_weeks], 
                          jhu_deaths[weekly_death_dates %in% est_weeks]),
                 # Source=rep(c("Deaths:NCHS", "Deaths:JHU"), each=length(est_weeks)))
                 Source=rep("Deaths:JHU", each=length(est_weeks)))

trans <- mean(dfH$Hosps) / mean(dfD$Deaths)

# Plot for dfH
p <- ggplot(dfH, aes(x = Date, y = Hosps, color = Source, linetype = Source)) + 
  geom_line() +
  ggtitle("US Hospitalizations and Deaths")
  scale_y_continuous(name = "Hospitalizations")

# Overlay the plot for dfD with a different scale
p <- p + geom_line(data = dfD, aes(x = Date, y = Deaths * trans, color = Source, linetype = Source)) +
  scale_y_continuous(sec.axis = sec_axis(~./trans, name = "Deaths")) +
  scale_color_manual(values = c("Hosps:HHS" = "blue", "Deaths:NCHS" = "red", "Deaths:JHU" = "brown")) +
  # scale_linetype_manual(values = c("Hosps:HHS" = "solid", "Deaths:NCHS" = "dashed", "Deaths:JHU" = "longdash")) +
  guides(color = guide_legend(title = "Data Source"), linetype = guide_legend(title = "Data Source"))

print(p)

```

```{r, fig.width=8, fig.height=9}

library(ggplot2)
library(gridExtra)

plots <- list()
lags <- c(7, 14, 21, 28)
for (lag in lags) {
  # death_weeks <- est_weeks+lag
  # dfAgg <- data.frame(Date=est_weeks, Hosps = hhs_hosps[weekly_hosp_dates %in% est_weeks], 
  #                     Deaths_NCHS=nchs_deaths[weekly_death_dates %in% death_weeks],
  #                     Deaths_JHU=jhu_deaths[weekly_death_dates %in% death_weeks])
  # death_weeks <- est_weeks+lag
  dfAgg <- data.frame(Date=est_weeks, Hosps = hhs_hosps[weekly_hosp_dates %in% (est_weeks-lag)],
                      Deaths_NCHS=nchs_deaths[weekly_death_dates %in% est_weeks],
                      Deaths_JHU=jhu_deaths[weekly_death_dates %in% est_weeks])
  
  dfAgg$Legend_JHU <- "Deaths, JHU"
  dfAgg$Legend_NCHS <- "Deaths, NCHS"
  dfAgg$Legend_HHS <- "Hospitalizations, HHS"
  p <- ggplot(dfAgg, aes(x = Date, y = Hosps)) +
    geom_line(aes(color=Legend_HHS, linetype=Legend_HHS)) + 
    ggtitle(paste0(lag, "-day Lag"))
  trans <- mean(hhs_hosps) / mean(jhu_deaths)
  position <- ifelse(lag==max(lags), "bottom", "none")
  p <- p + 
    geom_line(data = dfAgg, aes(x = Date, y = Deaths_NCHS * trans, color = Legend_NCHS, linetype = Legend_NCHS)) + 
    geom_line(data = dfAgg, aes(x = Date, y = Deaths_JHU * trans, color = Legend_JHU, linetype = Legend_JHU)) + 
    scale_y_continuous(name = "Hospitalizations", sec.axis = sec_axis(~./trans, name = "Deaths")) + 
    scale_linetype_manual(values = c("Hospitalizations, HHS" = "solid", "Deaths, NCHS" = "dashed", "Deaths, JHU" = "longdash")) +
    theme(legend.position=position,
          legend.title=element_blank())
  plots[[length(plots) + 1]] <- p
  
}

# Arrange plots and legend
grid.arrange(grobs = plots, nrow = length(lags))

```

```{r}
#, fig.width=6, fig.height=4 zzz
lag <- 28 # 21
# bad_dates <- as.Date(intersect(seq(as.Date("2022-01-01"), as.Date("2022-07-01"), by="day"), est_weeks))
bad_dates <- as.Date(intersect(seq(as.Date("2021-03-15"), as.Date("2021-10-01"), by="day"), est_weeks))
# hfrs <- compute_lagged_hfrs(hhs_hosps, jhu_deaths, l=lag, w=0, dates=bad_dates, weekly=TRUE)
# hfrs <- compute_ahfrs_dynamic(hhs_hosps_daily, jhu_deaths_daily, bad_dates, delay_shape2, w=0)
hfrs <- hfrsHJn[est_weeks %in% bad_dates] # change to l --> same results, just more dramatic
dfAgg <- data.frame(Date=bad_dates, Hosps = hhs_hosps_daily[names(hhs_hosps_daily) %in% (bad_dates-lag)]*7,
                    HFRs=hfrs,
                    # GT_HFRs=prop_variant_hfrs[est_weeks %in% bad_dates],
                    # GT_HFRs=hfrsHNlretro[est_weeks %in% bad_dates],
                    GT_HFRs=hfrsNHCS[est_weeks %in% bad_dates],
                    Deaths_JHU=jhu_deaths[weekly_death_dates %in% bad_dates])
dfAgg$Legend_JHU <- "Deaths, JHU"
dfAgg$Legend_HFR <- "Est HFRs, JHU"
dfAgg$Legend_HHS <- "Hospitalizations (Lagged)"
dfAgg$Legend_GT_HFR <- "GT HFRs"

trans <- max(hfrs) / max(jhu_deaths_est)
trans2 <- max(hfrs) / max(hhs_hosps_est)
trans3 <- mean(jhu_deaths_est)/mean(hhs_hosps_est)/mean(hfrsNHCS)

ggplot(data = dfAgg, aes(x = Date)) +
  ggtitle("JHU Deaths and Estimated HFRs", subtitle = paste0(lag, "-day Lag")) +
  geom_line(data = dfAgg, aes(y = HFRs, color = Legend_HFR, linetype = Legend_HFR)) +
  geom_line(data = dfAgg, aes(y = GT_HFRs * trans3, color = Legend_GT_HFR, linetype = Legend_GT_HFR)) +
  geom_line(data = dfAgg, aes(y = Deaths_JHU * trans, color = Legend_JHU, linetype = Legend_JHU)) + 
  geom_line(data = dfAgg, aes(y = Hosps * trans2, color=Legend_HHS, linetype=Legend_HHS)) + 
  scale_linetype_manual(values = c("GT HFRs" = "solid",
                                   "Hospitalizations (Lagged)" = "dotdash", 
                                   "Est HFRs, JHU" = "dashed", 
                                   "Deaths, JHU" = "longdash")) +
  scale_y_continuous(breaks = seq(from=0, to=0.25, by = 0.05), limits=c(0,0.25)) +
  # scale_y_continuous(breaks = seq(from=0, to=0.2, by = 0.05), limits=c(0,0.22)) +
  theme(legend.position="bottom",
        legend.title=element_blank())
```

Can theory explain the bias? 
- Mid-Omicron: Yes
```{r}
# t <- as.Date("2022-04-23")
t <- as.Date("2022-08-01")
est_days <- seq(min(est_weeks), max(est_weeks), by="day")
gt_hfrs_daily <- spline(est_weeks, hfrsNHCS, n=max(est_weeks)-min(est_weeks)+1)$y * trans3 *1.3
names(gt_hfrs_daily) <- est_days

# "True" HFR=
true_hfr <- round(gt_hfrs_daily[est_days==t], 3)
paste("True HFR at",t,":", true_hfr)
trailing_dates <- seq(t-d, t, by="day")
trailing_hfrs <- gt_hfrs_daily[est_days %in% trailing_dates]

# params <- get_gamma_params(Mean=25, Sd=20)
d <- 60
params <- get_gamma_params(Mean=28, Sd=25)
shape <- params[1]; rate <- params[2]
DelayShape <- ddgamma(0:d, shape, rate)
# plot(DelayShape)

d <- length(delay_shape) - 1
hosps_in_trailing_window <- hhs_hosps_daily[names(hhs_hosps_daily) %in% trailing_dates]
contributing_hosps <- sum(rev(hosps_in_trailing_window) * DelayShape)
exp_deaths <- sum(hosps_in_trailing_window * trailing_hfrs * rev(DelayShape))
# Expected Nishiura aHFR: 
nish_exp <- round(exp_deaths/contributing_hosps, 3)
paste("Expected Nishiura estimate:", nish_exp)

# Observed Nishiura aHFR. 
nish_obs <- round(jhu_deaths_daily[names(jhu_deaths_daily)==t]/contributing_hosps, 3)
paste("Observed Nishiura estimate:", nish_obs)

# compute_ahfr_dynamic(hhs_hosps_daily, jhu_deaths_daily, t, DelayShape, w=0) 

# # What is even the right delay distribution???
est_weeks_sub <- est_weeks[est_weeks >= t-d & est_weeks <= t]
exp_deaths_est <- sapply(est_weeks_sub, function(t) {
  trailing_dates <- seq(t-d, t, by="day")
  hosps_in_trailing_window <- hhs_hosps_daily[names(hhs_hosps_daily) %in% trailing_dates]
  exp_deaths <- sum(hosps_in_trailing_window * trailing_hfrs * rev(DelayShape))
}) # SCALE UP NHCS HFRs. Needs more than average bc messed up at the end.
deathsDF <- data.frame(Date=rep(est_weeks_sub,2),
                       Deaths=c(jhu_deaths_est[est_weeks >= t-d & est_weeks <= t]/7, exp_deaths_est),
                       Source=c(rep("JHU",length(est_weeks_sub)), rep("Expected",length(est_weeks_sub))))
ggplot(deathsDF, aes(x=Date, y=Deaths, color=Source)) + geom_line() +
  ggtitle(paste0("True HFR: ", true_hfr*100, "%, Expected aHFR: ", 
                 nish_exp*100, "%, Observed aHFR: ", nish_obs*100, "%"))
# plot(est_weeks_sub, jhu_deaths_est[est_weeks >= t-d & est_weeks <= t]/7, type="l")
# lines(est_weeks_sub, exp_deaths_est *1.15, type="l", col="red")
```









```{r}
lag <- 7 #, fig.width=6, fig.height=4
# bad_dates <- as.Date(intersect(seq(as.Date("2022-01-01"), as.Date("2022-07-01"), by="day"), est_weeks))
bad_dates <- as.Date(intersect(seq(as.Date("2021-06-15"), as.Date("2021-10-01"), by="day"), est_weeks))
hfrs <- hfrsHNn[est_weeks %in% bad_dates]
dfAgg <- data.frame(Date=bad_dates, Hosps = hhs_hosps[weekly_hosp_dates %in% (bad_dates-lag)],
                    HFRs=hfrs,
                    GT_HFRs=hfrsNHCS[est_weeks %in% bad_dates],
                    Deaths_NCHS=nchs_deaths[weekly_death_dates %in% bad_dates])
dfAgg$Legend_NCHS <- "Deaths, NCHS"
dfAgg$Legend_HFR <- "Est HFRs, NCHS"
dfAgg$Legend_GT_HFR <- "GT HFRs"
dfAgg$Legend_HHS <- "Hospitalizations (Lagged)"

# trans <- max(hfrs) / max(nchs_deaths)
# trans2 <- max(hfrs) / max(hhs_hosps)
ggplot(data = dfAgg, aes(x = Date)) +
  geom_line(data = dfAgg, aes(y = HFRs, color = Legend_HFR, linetype = Legend_HFR)) +
  geom_line(data = dfAgg, aes(y = Deaths_NCHS * trans, color = Legend_NCHS, linetype = Legend_NCHS)) +
  geom_line(data = dfAgg, aes(y = GT_HFRs * trans3, color = Legend_GT_HFR, linetype = Legend_GT_HFR)) +
  geom_line(data = dfAgg, aes(y = Hosps * trans2, color=Legend_HHS, linetype=Legend_HHS)) +
  scale_y_continuous(breaks = seq(from=0, to=0.3, by = 0.1), limits=c(0,0.35)) +
  # scale_y_continuous(breaks = seq(from=0, to=0.2, by = 0.05), limits=c(0,0.22)) +
  scale_linetype_manual(values = c("Hospitalizations (Lagged)" = "dotdash", 
                                   "GT HFRs" = "solid",
                                   "Est HFRs, NCHS" = "dashed", 
                                   "Deaths, NCHS" = "longdash")) +
  # ggtitle("NCHS Deaths and Estimated HFRs", subtitle = paste0(lag, "-day Lag")) +
  ggtitle("NCHS Deaths and Estimated HFRs") +
  theme(legend.position="bottom",
        legend.title=element_blank())
```
## Can JHU's bias be fixed with a longer delay distribution?
## NO! Turns out bias is (partly) because the HFRs declined too.

```{r}
params <- get_gamma_params(Mean=25, Sd=15) # Produces Mean & Sd ~ 1.5 below desired value
shape <- params[1]; rate <- params[2]
# shape <- 1.17; rate <- .11
delay_shape2 <- ddgamma(0:d, shape, rate)
sum(0:d*delay_shape2)
plot(delay_shape2)

hfrsHJn2 <- compute_ahfrs_dynamic(hhs_hosps_daily, jhu_deaths_daily, est_weeks, delay_shape2, w=0)

HFRtypes <- c("JHU/HHS (real-time)", "NHCS Survey", "NCHS/HHS (retro)", "GT-Variants")

dfHFR <- data.frame(Date=rep(est_weeks, length(HFRtypes)),
                 HFR=c(hfrsHJn2, hfrsNHCS, hfrsHNlretro, prop_variant_hfrs), 
                 Method=factor(rep(HFRtypes, each=length(hfrsNHCS)), levels=HFRtypes))

# labels <- c("Alpha", "Delta", "Omicron")
labels <- c("Alpha", "Delta", "Omicron", "Late Omicron")
date_vec <- variant_dates[labels]
ggplot(data=dfHFR, aes(x = Date, y = HFR, color = Method, linetype = Method)) + 
  geom_line() + labs(color = "HFR", linetype = "HFR") + 
  geom_vline(xintercept = as.numeric(date_vec), color = "black") +
  ggtitle("US HFRs, JHU vs approximate ground truth, longer delay distribution")


```
















##### Now repeat on different states, see if it's the same

```{r}
# df.state <- readRDS(file.path(nat_data_path, "seq_prop_df.rds"))
# df.state <- df.state[c("State", "Date", variants)]
# df.state[variants] <- df.state[variants]/rowSums(df.state[variants])
# state_hfrs <- matrix(unlist(df.state[,variants]), ncol=n_variants) %*% variant_hfrs
# state.hfrs <- data.frame(df.state[,!(names(df.state) %in% all_variants)], HFR=state_hfrs)
# # head(state.hfrs)
# nat_hfrs <- matrix(unlist(dfDaily[,variants]), ncol=n_variants) %*% variant_hfrs
# nat.hfrs <- data.frame(State=rep("US", length(nat_hfrs)), Date=dfDaily$Date, 
#                   HFR=nat_hfrs)
# 
# sim_hfrs <- rbind(state.hfrs, nat.hfrs)

```

```{r}
l <- list()
for (i in 1:5) {
  l <- c(l, i)
}
l[[3]]
```



```{r, fig.width=7, fig.height=5}
l <- list()

# Select state
BiggestStates <- c("California", "Texas", "Florida", "New York", "Pennsylvania")
BiggestSTs <- c("CA","TX","FL","NY","PA")
for (i in 1:5) {
  State <- BiggestStates[i]; ST <- BiggestSTs[i]; st <- tolower(ST)
  # Load NCHS deaths (weekly)
  nchs_df <- data.frame(pub_covidcast(source="nchs-mortality",signals= "deaths_covid_incidence_num", 
                                     geo_type = "state", geo_values=st, 
                                     time_type="week"))
  # Shift, to use end-of-week
  nchs_df$time_value <- nchs_df$time_value + 6
  weekly_dates_nchs <- as.Date(nchs_df$time_value, format = "%b %d %Y")
  
  # Load JHU deaths (daily, smoothed)
  jhu_df <- data.frame(pub_covidcast(source="jhu-csse", signals="deaths_7dav_incidence_num",
                                      geo_type = "state", geo_values=st, 
                                      time_type="day"))

  # Take overlapping dates
  max_jhu_date <- as.Date("2023-03-01") # Sometimes messed up in this next week
  weekly_death_dates <- weekly_dates_nchs[weekly_dates_nchs>=(min(jhu_df$time_value)+6) &
                                    weekly_dates_nchs <= min(max(jhu_df$time_value), max_jhu_date)]
  first_date <- min(weekly_death_dates); last_date <- max(weekly_death_dates)
  nchs_deaths <- nchs_df$value[nchs_df$time_value %in% weekly_death_dates]; names(nchs_deaths) <- weekly_death_dates
  jhu_deaths_daily <- jhu_df$value[jhu_df$time_value >= first_date & jhu_df$time_value <= last_date]
  daily_dates <- seq(first_date, last_date, by="day")
  names(jhu_deaths_daily) <- daily_dates
  
  # Convert to weekly totals
  jhu_deaths <- sapply(weekly_death_dates, function(date) {
    sum(jhu_deaths_daily[daily_dates %in% seq(date - 6, date, by="day")], na.rm = TRUE)
  }); names(jhu_deaths) <- weekly_death_dates

  
  plot(weekly_death_dates,jhu_deaths, type="l", main=paste("Weekly Deaths,", State), 
       ylab="Deaths", xlab="Dates",ylim=c(0,max(jhu_deaths,nchs_deaths,na.rm=T)))
  lines(weekly_death_dates,nchs_deaths, col="red")
  legend("topright", legend=c("JHU", "NCHS"),
         col=c("black", "red"), lty=1)
  
  # Pull state hospitalizations
  hhs_df <- data.frame(pub_covidcast(source="hhs",signals= "confirmed_admissions_covid_1d", 
                                   geo_type = "state", geo_values=st, 
                                   time_type="day"))
  last_hosp_date <- max(hhs_df$time_value)
  
  # Saturdays with hospitalizations
  weekly_hosp_dates <- weekly_death_dates[weekly_death_dates >= (first_hosp_date+6) & weekly_death_dates <= last_hosp_date]
  hhs_hosps <- sapply(weekly_hosp_dates, function(day) {
    day <- as.Date(day)
    week <- hhs_df[hhs_df$time_value %in% seq(day-6, day, "day"), ]
    sum(week$value)
  }); names(hhs_hosps) <- weekly_hosp_dates
  
  est_weeks <- weekly_hosp_dates[12:(length(weekly_hosp_dates)-14)]
  
  hfrsHN <- compute_lagged_hfrs(hhs_hosps, nchs_deaths,
                                     l=14, w=28, dates=est_weeks, weekly=TRUE, real_time=FALSE)
  hfrsHJ <- compute_lagged_hfrs(hhs_hosps, jhu_deaths,
                                     l=21, w=28, dates=est_weeks, weekly=TRUE, real_time=TRUE)
  HFRtypes <- c(paste(ST, "NCHS/HHS"), paste(ST, "JHU/HHS"))#"US:NHCS", 
  dfHFR <- data.frame(Date=rep(est_weeks, length(HFRtypes)),
                   HFR=c(hfrsHN, hfrsHJ),#hfrsNHCS
                   Method=factor(rep(HFRtypes, each=length(est_weeks)), levels=HFRtypes))
  p <- ggplot(dfHFR, aes(x = Date, y = HFR, color = Method, linetype = Method)) + 
    geom_line() + 
    labs(color = "HFR", linetype = "HFR") + ggtitle(paste("HFRs,", State))
  plot(p)
  l <- c(l, p)
}


```



Repeat on small state
- JHU always reported deaths; NCHS did not

```{r}
SmallestStates <- c("Alaska", "North Dakota", "South Dakota", "Delaware", "Montana")
SmallestSTs <- c("AK","ND","SD","DE","MT")
for (i in 1:5) {
  State <- SmallestStates[i]; ST <- SmallestSTs[i]; st <- tolower(ST)
  # Load NCHS deaths (weekly)
  nchs_df <- data.frame(pub_covidcast(source="nchs-mortality",signals= "deaths_covid_incidence_num", 
                                     geo_type = "state", geo_values=st, 
                                     time_type="week"))
  # Shift, to use end-of-week
  nchs_df$time_value <- nchs_df$time_value + 6
  weekly_dates_nchs <- as.Date(nchs_df$time_value, format = "%b %d %Y")
  
  # Load JHU deaths (daily, smoothed)
  jhu_df <- data.frame(pub_covidcast(source="jhu-csse", signals="deaths_7dav_incidence_num",
                                      geo_type = "state", geo_values=st, 
                                      time_type="day"))

  # Take overlapping dates
  max_jhu_date <- as.Date("2023-03-01") # Sometimes messed up in this next week
  weekly_death_dates <- weekly_dates_nchs[weekly_dates_nchs>=(min(jhu_df$time_value)+6) &
                                    weekly_dates_nchs <= min(max(jhu_df$time_value), max_jhu_date)]
  first_date <- min(weekly_death_dates); last_date <- max(weekly_death_dates)
  nchs_deaths <- nchs_df$value[nchs_df$time_value %in% weekly_death_dates]; names(nchs_deaths) <- weekly_death_dates
  jhu_deaths_daily <- jhu_df$value[jhu_df$time_value >= first_date & jhu_df$time_value <= last_date]
  daily_dates <- seq(first_date, last_date, by="day")
  names(jhu_deaths_daily) <- daily_dates
  
  # Convert to weekly totals
  jhu_deaths <- sapply(weekly_death_dates, function(date) {
    sum(jhu_deaths_daily[daily_dates %in% seq(date - 6, date, by="day")], na.rm = TRUE)
  }); names(jhu_deaths) <- weekly_death_dates

  
  plot(weekly_death_dates,jhu_deaths, type="l", main=paste("Weekly Deaths,", State), 
       ylab="Deaths", xlab="Dates",ylim=c(0,max(jhu_deaths,nchs_deaths,na.rm=T)))
  lines(weekly_death_dates,nchs_deaths, col="red")
  legend("topright", legend=c("JHU", "NCHS"),
         col=c("black", "red"), lty=1)
  
  # Pull state hospitalizations
  hhs_df <- data.frame(pub_covidcast(source="hhs",signals= "confirmed_admissions_covid_1d", 
                                   geo_type = "state", geo_values=st, 
                                   time_type="day"))
  last_hosp_date <- max(hhs_df$time_value)
  
  # Saturdays with hospitalizations
  weekly_hosp_dates <- weekly_death_dates[weekly_death_dates >= (first_hosp_date+6) & weekly_death_dates <= last_hosp_date]
  hhs_hosps <- sapply(weekly_hosp_dates, function(day) {
    day <- as.Date(day)
    week <- hhs_df[hhs_df$time_value %in% seq(day-6, day, "day"), ]
    sum(week$value)
  }); names(hhs_hosps) <- weekly_hosp_dates
  
  est_weeks <- weekly_hosp_dates[12:(length(weekly_hosp_dates)-14)]
  
  hfrsHN <- compute_lagged_hfrs(hhs_hosps, nchs_deaths,
                                     l=14, w=28, dates=est_weeks, weekly=TRUE)
  hfrsHJ <- compute_lagged_hfrs(hhs_hosps, jhu_deaths,
                                     l=21, w=28, dates=est_weeks, weekly=TRUE)
  HFRtypes <- c(paste(ST, "NCHS/HHS"), paste(ST, "JHU/HHS"))#"US:NHCS", 
  dfHFR <- data.frame(Date=rep(est_weeks, length(HFRtypes)),
                   HFR=c(hfrsHN, hfrsHJ),#hfrsNHCS
                   Method=rep(HFRtypes, each=length(est_weeks)))
  
  plot(ggplot(dfHFR, aes(x = Date, y = HFR, color = Method, linetype = Method)) + 
    geom_line() + 
    labs(color = "HFR", linetype = "HFR") + ggtitle(paste("HFRs,", State)))
}
```


